{% extends 'base.html' %}

{% block title %}Email Settings - Admin - CRM{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Email Settings</h1>
        <p class="text-gray-600 mt-2">Configure SMTP settings and email templates for ticket confirmations</p>
    </div>

    {% if request.session.get('flash_message') %}
    <div class="mb-6 p-4 rounded-lg {% if request.session.get('flash_type') == 'success' %}bg-green-50 border border-green-200 text-green-800{% else %}bg-red-50 border border-red-200 text-red-800{% endif %}">
        {{ request.session.pop('flash_message') }}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- SMTP Settings -->
        <div class="lg:col-span-2">
            <form method="post" action="/web/admin/email-settings/save">
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-server text-blue-600 mr-2"></i>
                        SMTP Configuration
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">SMTP Host (Outgoing Server) *</label>
                            <input type="text" name="smtp_host" required
                                   value="{{ settings.smtp_host if settings else '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="mail.yourdomain.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">SMTP Port *</label>
                            <input type="number" name="smtp_port" required
                                   value="{{ settings.smtp_port if settings else 587 }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="587">
                            <p class="text-xs text-gray-500 mt-1">Standard: 587 (TLS) or 465 (SSL)</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username (Email) *</label>
                        <input type="email" name="smtp_username" required
                               value="{{ settings.smtp_username if settings else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="support@yourdomain.com">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" name="smtp_password" required
                               value="{{ settings.smtp_password if settings else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <p class="text-xs text-gray-500 mt-1">
                            Your email account password for the outgoing mail server
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">From Email *</label>
                            <input type="email" name="smtp_from_email" required
                                   value="{{ settings.smtp_from_email if settings else '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="support@yourdomain.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">From Name *</label>
                            <input type="text" name="smtp_from_name" required
                                   value="{{ settings.smtp_from_name if settings else '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Support Team">
                        </div>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <input type="checkbox" name="smtp_use_tls" value="true" id="smtp_use_tls"
                               {% if not settings or settings.smtp_use_tls %}checked{% endif %}
                               class="mr-2">
                        <label for="smtp_use_tls" class="text-sm text-gray-700">Use TLS (Recommended for Port 587)</label>
                    </div>
                </div>

                <!-- Incoming Mail Settings -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-inbox text-green-600 mr-2"></i>
                        Incoming Mail Configuration (Email-to-Ticket)
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mail Type</label>
                        <select name="incoming_mail_type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="POP3" {% if not settings or settings.incoming_mail_type == 'POP3' %}selected{% endif %}>POP3</option>
                            <option value="IMAP" {% if settings and settings.incoming_mail_type == 'IMAP' %}selected{% endif %}>IMAP</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Incoming Mail Server</label>
                            <input type="text" name="incoming_mail_host"
                                   value="{{ settings.incoming_mail_host if settings and settings.incoming_mail_host else '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                   placeholder="mail.yourdomain.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Incoming Port</label>
                            <input type="number" name="incoming_mail_port"
                                   value="{{ settings.incoming_mail_port if settings and settings.incoming_mail_port else 110 }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                   placeholder="110">
                            <p class="text-xs text-gray-500 mt-1">POP3: 110 (995 SSL) | IMAP: 143 (993 SSL)</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Incoming Mail Username</label>
                        <input type="text" name="incoming_mail_username"
                               value="{{ settings.incoming_mail_username if settings and settings.incoming_mail_username else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="support@yourdomain.com">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Incoming Mail Password</label>
                        <input type="password" name="incoming_mail_password"
                               value="{{ settings.incoming_mail_password if settings and settings.incoming_mail_password else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Webmail URL (Optional)</label>
                        <input type="url" name="webmail_url"
                               value="{{ settings.webmail_url if settings and settings.webmail_url else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="https://webmail.yourdomain.com">
                        <p class="text-xs text-gray-500 mt-1">Link to your webmail interface for reference</p>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="incoming_mail_use_ssl" value="true" id="incoming_mail_ssl"
                               {% if settings and settings.incoming_mail_use_ssl %}checked{% endif %}
                               class="mr-2">
                        <label for="incoming_mail_ssl" class="text-sm text-gray-700">Use SSL for incoming mail</label>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-envelope text-blue-600 mr-2"></i>
                        Email Template
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                        <input type="text" name="company_name" required
                               value="{{ settings.company_name if settings else 'Support Team' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Your Company Name">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Subject *</label>
                        <input type="text" name="confirmation_subject" required
                               value="{{ settings.confirmation_subject if settings else 'Ticket Confirmation - #{ticket_number}' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ticket Confirmation - #{ticket_number}">
                        <p class="text-xs text-gray-500 mt-1">Available variables: {ticket_number}, {subject}, {priority}</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Body *</label>
                        <textarea name="confirmation_body" rows="12" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm">{{ settings.confirmation_body if settings else default_body }}</textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            Available variables: {guest_name}, {guest_surname}, {ticket_number}, {subject}, {priority}, {company_name}
                        </p>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="auto_reply_enabled" value="true" id="auto_reply"
                               {% if not settings or settings.auto_reply_enabled %}checked{% endif %}
                               class="mr-2">
                        <label for="auto_reply" class="text-sm text-gray-700">Enable automatic confirmation emails</label>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="debugSettings()"
                            class="px-4 py-2 border border-gray-300 bg-gray-50 rounded-md text-gray-700 hover:bg-gray-100 text-sm">
                        <i class="fas fa-bug mr-1"></i>Debug
                    </button>
                    <button type="button" onclick="previewInbox()"
                            class="px-6 py-2 border border-teal-300 bg-teal-50 rounded-md text-teal-700 hover:bg-teal-100">
                        <i class="fas fa-inbox mr-2"></i>Preview Inbox
                    </button>
                    <button type="button" onclick="checkEmails()"
                            class="px-6 py-2 border border-purple-300 bg-purple-50 rounded-md text-purple-700 hover:bg-purple-100">
                        <i class="fas fa-sync mr-2"></i>Check Emails Now
                    </button>
                    <button type="button" onclick="sendTestEmail()"
                            class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-paper-plane mr-2"></i>Send Test Email
                    </button>
                    <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Save Settings
                    </button>
                </div>
            </form>
            
            <!-- Inbox Preview Section -->
            <div id="inboxPreview" class="mt-6 hidden">
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-inbox text-teal-600 mr-2"></i>
                        Inbox Preview (Last 10 Emails)
                    </h3>
                    <div id="inboxContent">
                        <div class="text-center py-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
                            <p class="text-gray-600 mt-2">Loading emails...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="space-y-6">
            <div class="bg-blue-50 rounded-lg p-6">
                <h3 class="font-semibold text-blue-900 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Guest Ticket URL
                </h3>
                <p class="text-sm text-blue-800 mb-3">Share this URL with clients to submit tickets:</p>
                <div class="bg-white rounded border border-blue-200 p-3">
                    <code class="text-xs text-blue-900 break-all">{{ request.url.scheme }}://{{ request.url.netloc }}/web/tickets/guest</code>
                </div>
                <button onclick="copyGuestURL()" class="mt-3 w-full px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                    <i class="fas fa-copy mr-2"></i>Copy URL
                </button>
            </div>

            <div class="bg-green-50 rounded-lg p-6">
                <h3 class="font-semibold text-green-900 mb-3 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Setup Complete
                </h3>
                <ul class="space-y-2 text-sm text-green-800">
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                        Configure SMTP settings above
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                        Customize email template
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                        Share guest ticket URL
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                        Clients receive confirmation emails
                    </li>
                </ul>
            </div>

            <div class="bg-amber-50 rounded-lg p-6">
                <h3 class="font-semibold text-amber-900 mb-3 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Gmail Users
                </h3>
                <p class="text-sm text-amber-800 mb-2">For Gmail accounts:</p>
                <ol class="space-y-1 text-xs text-amber-700 list-decimal list-inside">
                    <li>Enable 2-Factor Authentication</li>
                    <li>Generate an App Password</li>
                    <li>Use App Password above (not your Gmail password)</li>
                </ol>
                <a href="https://support.google.com/accounts/answer/185833" target="_blank"
                   class="text-xs text-amber-900 underline hover:text-amber-700 mt-2 inline-block">
                    Learn more ‚Üí
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function copyGuestURL() {
    const url = "{{ request.url.scheme }}://{{ request.url.netloc }}/web/tickets/guest";
    navigator.clipboard.writeText(url).then(() => {
        alert('Guest ticket URL copied to clipboard!');
    });
}

function sendTestEmail() {
    if (confirm('This will send a test email to the configured email address. Continue?')) {
        fetch('/web/admin/email-settings/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úì Test email sent successfully! Check your inbox.');
            } else {
                alert('‚úó Failed to send test email: ' + data.error);
            }
        })
        .catch(err => {
            alert('‚úó Error: ' + err.message);
        });
    }
}

function debugSettings() {
    fetch('/web/admin/email-settings/debug', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const settings = data.settings;
            let msg = 'üìß EMAIL SETTINGS IN DATABASE:\n\n';
            msg += `SMTP (Outgoing):\n`;
            msg += `  Host: ${settings.smtp_host}\n`;
            msg += `  Port: ${settings.smtp_port}\n`;
            msg += `  Username: ${settings.smtp_username}\n\n`;
            msg += `IMAP/POP3 (Incoming):\n`;
            msg += `  Type: ${settings.mail_type || 'NOT SET'}\n`;
            msg += `  Host: ${settings.incoming_mail_host || 'NOT SET'}\n`;
            msg += `  Port: ${settings.incoming_mail_port || 'NOT SET'}\n`;
            msg += `  Username: ${settings.incoming_mail_username || 'NOT SET'}\n`;
            msg += `  SSL: ${settings.incoming_mail_use_ssl ? 'YES' : 'NO'}\n`;
            msg += `  Workspace ID: ${settings.workspace_id}\n\n`;
            
            if (data.processed_emails && data.processed_emails.length > 0) {
                msg += `\nüì¨ RECENT SENT EMAILS (for reply tracking):\n`;
                msg += `Total: ${data.processed_emails.length}\n\n`;
                data.processed_emails.forEach((email, i) => {
                    msg += `${i+1}. Ticket #${email.ticket_id || 'N/A'}\n`;
                    msg += `   Subject: ${email.subject}\n`;
                    msg += `   Message-ID: ${email.message_id}\n`;
                    msg += `   Sent at: ${email.processed_at}\n\n`;
                });
            } else {
                msg += `\n‚ö†Ô∏è No sent emails tracked yet\n`;
                msg += `Replies can only be detected if the original email was sent by the system.\n`;
            }
            
            alert(msg);
        } else {
            alert('‚ùå ' + data.error);
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    });
}
        } else {
            alert('‚ùå ' + data.error);
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    });
}

function checkEmails() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Checking...';
    
    fetch('/web/admin/email-settings/check-emails', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'Check Emails Now';
        
        if (data.success) {
            if (data.tickets_created > 0) {
                alert(`‚úì Found ${data.tickets_created} new email(s)!\n\nTickets: ${data.ticket_numbers.join(', ')}`);
            } else {
                alert('‚úì Email check complete. No new emails found.');
            }
        } else {
            alert('‚úó Failed to check emails: ' + data.error + '\n\nDetails: ' + (data.details || 'None'));
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Check Emails Now';
        alert('‚úó Error: ' + err.message);
    });
}

function previewInbox() {
    const previewDiv = document.getElementById('inboxPreview');
    const contentDiv = document.getElementById('inboxContent');
    
    // Show the preview section
    previewDiv.classList.remove('hidden');
    
    // Reset to loading state
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
            <p class="text-gray-600 mt-2">Loading emails...</p>
        </div>
    `;
    
    // Scroll to preview
    previewDiv.scrollIntoView({ behavior: 'smooth' });
    
    fetch('/web/admin/email-settings/preview-inbox', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.emails.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-300 text-4xl mb-2"></i>
                        <p class="text-gray-600">No emails found in inbox</p>
                    </div>
                `;
            } else {
                let html = '<div class="space-y-3">';
                data.emails.forEach(email => {
                    const statusColor = email.is_unread ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200';
                    const statusIcon = email.is_unread ? '<span class="text-blue-600 font-semibold mr-2">‚óè</span>' : '';
                    html += `
                        <div class="${statusColor} border rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">
                                        ${statusIcon}${email.subject || '(No Subject)'}
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        From: ${email.from}
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 ml-4">
                                    ${email.date}
                                </div>
                            </div>
                            ${email.in_reply_to ? `
                                <div class="text-xs text-purple-600 mt-1">
                                    <i class="fas fa-reply mr-1"></i>Reply (In-Reply-To: ${email.in_reply_to.substring(0, 30)}...)
                                </div>
                            ` : ''}
                            ${email.preview ? `
                                <div class="text-sm text-gray-700 mt-2 border-t pt-2">
                                    ${email.preview.substring(0, 150)}${email.preview.length > 150 ? '...' : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                contentDiv.innerHTML = html;
            }
        } else {
            contentDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        ${data.error || 'Failed to load inbox'}
                    </p>
                    ${data.details ? `<p class="text-sm text-red-600 mt-2">${data.details}</p>` : ''}
                </div>
            `;
        }
    })
    .catch(err => {
        contentDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Error: ${err.message}
                </p>
            </div>
        `;
    });
}
</script>
{% endblock %}
