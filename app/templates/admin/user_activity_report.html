{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">User Activity Reports</h1>
    <p class="text-gray-600">Generate detailed PDF reports of user activity</p>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Generate Report</h2>
    
    <form method="get" id="reportForm" class="space-y-6">
      <!-- User Selection -->
      <div>
        <label for="target_user_id" class="block text-sm font-medium text-gray-700 mb-2">Select User</label>
        <select id="target_user_id" name="target_user_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">-- Select a user --</option>
          {% for usr in users %}
            <option value="{{ usr.id }}">
              {{ usr.full_name or usr.username }}
              {% if usr.is_admin %}(Admin){% endif %}
              {% if not usr.is_active %}[Inactive]{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Date Range -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
          <input type="date" id="start_date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-gray-500 mt-1">Leave empty for last 30 days</p>
        </div>

        <div>
          <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
          <input type="date" id="end_date" name="end_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-gray-500 mt-1">Leave empty for today</p>
        </div>
      </div>

      <!-- Quick Date Ranges -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Select</label>
        <div class="flex flex-wrap gap-2">
          <button type="button" onclick="setDateRange(7)" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">Last 7 Days</button>
          <button type="button" onclick="setDateRange(30)" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">Last 30 Days</button>
          <button type="button" onclick="setDateRange(90)" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">Last 90 Days</button>
          <button type="button" onclick="setThisMonth()" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">This Month</button>
          <button type="button" onclick="setLastMonth()" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">Last Month</button>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex gap-4">
        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          ðŸ“„ Generate PDF Report
        </button>
        <a href="/web/admin/users" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
          Cancel
        </a>
      </div>
    </form>
  </div>

  <!-- Report Info -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
    <h3 class="font-semibold text-blue-900 mb-2">ðŸ“Š Report Contents</h3>
    <p class="text-sm text-blue-800 mb-2">The generated PDF report will include:</p>
    <ul class="text-sm text-blue-800 space-y-1 ml-4">
      <li>â€¢ Summary of all activity types</li>
      <li>â€¢ Tasks created by the user</li>
      <li>â€¢ Task assignments received</li>
      <li>â€¢ Task edits and modifications</li>
      <li>â€¢ Comments posted</li>
      <li>â€¢ Projects created</li>
      <li>â€¢ Activities logged (calls, emails, meetings, notes)</li>
    </ul>
  </div>
</div>

<script>
document.getElementById('reportForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const userId = document.getElementById('target_user_id').value;
  if (!userId) {
    alert('Please select a user');
    return;
  }
  
  const startDate = document.getElementById('start_date').value;
  const endDate = document.getElementById('end_date').value;
  
  let url = `/web/admin/reports/user-activity/${userId}/pdf`;
  const params = new URLSearchParams();
  
  if (startDate) params.append('start_date', startDate);
  if (endDate) params.append('end_date', endDate);
  
  if (params.toString()) {
    url += '?' + params.toString();
  }
  
  // Open PDF in new tab
  window.open(url, '_blank');
});

function setDateRange(days) {
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - days);
  
  document.getElementById('start_date').value = start.toISOString().split('T')[0];
  document.getElementById('end_date').value = end.toISOString().split('T')[0];
}

function setThisMonth() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  document.getElementById('start_date').value = start.toISOString().split('T')[0];
  document.getElementById('end_date').value = end.toISOString().split('T')[0];
}

function setLastMonth() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const end = new Date(now.getFullYear(), now.getMonth(), 0);
  
  document.getElementById('start_date').value = start.toISOString().split('T')[0];
  document.getElementById('end_date').value = end.toISOString().split('T')[0];
}
</script>
{% endblock %}
