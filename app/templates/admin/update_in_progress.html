{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto text-center py-12">
  <div class="bg-blue-50 rounded-lg border border-blue-200 p-8">
    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
    
    <h1 class="text-2xl font-bold text-slate-900 mb-2">Update Installing...</h1>
    <p class="text-slate-600 mb-6">{{ message }}</p>
    
    <div class="bg-white rounded-lg p-4 text-left text-sm text-slate-700 space-y-2">
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></div>
        <span>Stopping service...</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-slate-300 rounded-full"></div>
        <span>Backing up database...</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-slate-300 rounded-full"></div>
        <span>Downloading updates from GitHub...</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-slate-300 rounded-full"></div>
        <span>Installing dependencies...</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-slate-300 rounded-full"></div>
        <span>Running migrations...</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-slate-300 rounded-full"></div>
        <span>Restarting service...</span>
      </div>
    </div>
    
    <div class="mt-6 text-sm text-slate-500">
      <p>This page will refresh automatically when the update completes.</p>
      <p class="mt-1">Estimated time: 30-60 seconds</p>
    </div>
  </div>
</div>

<script>
// Auto-refresh after 60 seconds to check if service is back up
setTimeout(() => {
  window.location.href = '/web/admin/updates';
}, 60000);

// Poll server every 5 seconds to see if it's back up
let checkCount = 0;
const checkInterval = setInterval(async () => {
  checkCount++;
  try {
    const response = await fetch('/api/health');
    if (response.ok) {
      clearInterval(checkInterval);
      window.location.href = '/web/admin/updates';
    }
  } catch (e) {
    // Server still down, keep polling
  }
  
  // Stop checking after 2 minutes
  if (checkCount > 24) {
    clearInterval(checkInterval);
  }
}, 5000);
</script>
{% endblock %}
