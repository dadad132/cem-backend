{% extends "base.html" %}
{% block content %}
<div class="mb-5">
  <h1 class="text-2xl font-semibold">Activity Feed</h1>
  <p class="text-sm text-slate-500 mt-1">See what's happening across your workspace in real-time</p>
</div>

<!-- User Statistics Section -->
{% if user_stats %}
<div class="mb-6">
  {% if user.is_admin %}
    <h2 class="text-lg font-semibold mb-3">Team Performance (Last 30 Days)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      {% for stat in user_stats %}
        <div class="bg-white rounded-lg border border-slate-200 p-4 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between mb-3">
            <div>
              <div class="font-semibold text-slate-900">{{ stat.user_name }}</div>
              <div class="text-xs text-slate-500">{{ stat.user_email }}</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-medium text-blue-700">
              {{ stat.user_name[:1] }}
            </div>
          </div>
          
          {% if stat.current_task %}
            <div class="mb-3 p-2 bg-blue-50 rounded border border-blue-200">
              <div class="text-xs text-blue-600 font-medium mb-1">Currently Working On:</div>
              <a href="/web/tasks/{{ stat.current_task_id }}" class="text-sm text-blue-700 hover:underline">
                {{ stat.current_task }}
              </a>
            </div>
          {% else %}
            <div class="mb-3 p-2 bg-slate-50 rounded border border-slate-200">
              <div class="text-xs text-slate-500 italic">No active tasks</div>
            </div>
          {% endif %}
          
          <div class="grid grid-cols-3 gap-2 text-center">
            <div>
              <div class="text-xl font-bold text-green-600">{{ stat.completed_month }}</div>
              <div class="text-xs text-slate-600">Completed</div>
            </div>
            <div>
              <div class="text-xl font-bold text-orange-600">{{ stat.completed_late }}</div>
              <div class="text-xs text-slate-600">Late</div>
            </div>
            <div>
              <div class="text-xl font-bold text-red-600">{{ stat.overdue_count }}</div>
              <div class="text-xs text-slate-600">Overdue</div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <!-- Regular user sees their own stats -->
    {% for stat in user_stats %}
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 text-slate-900">Your Performance (Last 30 Days)</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-slate-200">
            <div class="text-2xl font-bold text-green-600">{{ stat.completed_month }}</div>
            <div class="text-sm text-slate-600">Tasks Completed</div>
          </div>
          
          <div class="bg-white rounded-lg p-4 border border-slate-200">
            <div class="text-2xl font-bold text-blue-600">{{ stat.completed_on_time }}</div>
            <div class="text-sm text-slate-600">On Time</div>
          </div>
          
          <div class="bg-white rounded-lg p-4 border border-slate-200">
            <div class="text-2xl font-bold text-orange-600">{{ stat.completed_late }}</div>
            <div class="text-sm text-slate-600">Completed Late</div>
          </div>
          
          <div class="bg-white rounded-lg p-4 border border-slate-200">
            <div class="text-2xl font-bold text-red-600">{{ stat.overdue_count }}</div>
            <div class="text-sm text-slate-600">Currently Overdue</div>
          </div>
        </div>
        
        <!-- Tasks completed late -->
        {% if stat.completed_late_tasks %}
          <div class="bg-white rounded-lg border border-orange-200 p-4 mb-4">
            <h3 class="font-medium text-orange-900 mb-2">Completed Late ({{ stat.completed_late|length }} tasks)</h3>
            <div class="space-y-2">
              {% for task in stat.completed_late_tasks %}
                <div class="flex items-center justify-between p-2 bg-orange-50 rounded">
                  <a href="/web/tasks/{{ task.id }}" class="text-sm text-slate-700 hover:text-blue-600">
                    {{ task.title }}
                  </a>
                  <div class="text-xs text-slate-500">
                    Due: {{ task.due_date.strftime('%d/%m/%Y') }} | 
                    Completed: {{ task.updated_at.strftime('%d/%m/%Y') if task.updated_at else 'N/A' }}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        
        <!-- Currently overdue tasks -->
        {% if stat.overdue_tasks %}
          <div class="bg-white rounded-lg border border-red-200 p-4">
            <h3 class="font-medium text-red-900 mb-2">Currently Overdue ({{ stat.overdue_count }} tasks)</h3>
            <div class="space-y-2">
              {% for task in stat.overdue_tasks %}
                <div class="flex items-center justify-between p-2 bg-red-50 rounded">
                  <a href="/web/tasks/{{ task.id }}" class="text-sm text-slate-700 hover:text-blue-600">
                    {{ task.title }}
                  </a>
                  <div class="text-xs text-red-600 font-medium">
                    Due: {{ task.due_date.strftime('%d/%m/%Y') }}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  {% endif %}
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <!-- Main feed -->
  <div class="lg:col-span-3 space-y-3">
    {% if activities %}
      {% for activity in activities %}
        <div class="bg-white rounded-lg border border-slate-200 p-4 hover:shadow-sm transition-shadow">
          <div class="flex items-start gap-3">
            <!-- Avatar -->
            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-medium flex-shrink-0">
              {{ activity.user_name[:1] if activity.user_name else '?' }}
            </div>
            
            <!-- Activity content -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-medium">{{ activity.user_name or 'Unknown User' }}</span>
                <span class="text-sm text-slate-500">{{ activity.action_text }}</span>
                {% if activity.entity_type == 'task' %}
                  <a href="/web/tasks/{{ activity.entity_id }}" class="text-blue-600 hover:underline text-sm">
                    {{ activity.entity_title or 'Task' }}
                  </a>
                {% elif activity.entity_type == 'project' %}
                  <a href="/web/projects/{{ activity.entity_id }}" class="text-blue-600 hover:underline text-sm">
                    {{ activity.entity_title or 'Project' }}
                  </a>
                {% endif %}
              </div>
              
              {% if activity.details %}
                <div class="text-sm text-slate-600 mt-1">
                  {{ activity.details }}
                </div>
              {% endif %}
              
              <div class="text-xs text-slate-400 mt-2">
                {{ activity.time_ago }}
              </div>
            </div>
            
            <!-- Entity type badge -->
            <div class="flex-shrink-0">
              {% if activity.entity_type == 'task' %}
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">Task</span>
              {% elif activity.entity_type == 'project' %}
                <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">Project</span>
              {% elif activity.entity_type == 'meeting' %}
                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Meeting</span>
              {% elif activity.entity_type == 'chat' %}
                <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded">Chat</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="bg-gradient-to-br from-blue-50 via-white to-purple-50 rounded-lg border-2 border-dashed border-slate-300 p-12">
        <div class="max-w-md mx-auto text-center">
          <!-- Animated Icon -->
          <div class="relative mb-6">
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="w-24 h-24 bg-blue-100 rounded-full animate-pulse"></div>
            </div>
            <div class="relative text-blue-500 mb-2">
              <svg class="w-24 h-24 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                      d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
          </div>
          
          <!-- Message -->
          <h3 class="text-2xl font-bold text-slate-800 mb-3">Let's Get Started!</h3>
          <p class="text-slate-600 mb-6">
            Your workspace is ready. Create your first project or task to start tracking your team's progress.
          </p>
          
          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 justify-center mb-8">
            <a href="/web/projects" 
               class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
              </svg>
              Create Project
            </a>
            
            <a href="/web/projects" 
               class="inline-flex items-center justify-center px-6 py-3 bg-white text-blue-600 font-medium rounded-lg border-2 border-blue-600 hover:bg-blue-50 transition-colors">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              View Tasks
            </a>
          </div>
          
          <!-- Quick Tips -->
          <div class="bg-white rounded-lg border border-slate-200 p-6 text-left">
            <h4 class="font-semibold text-slate-800 mb-3 flex items-center">
              <svg class="w-5 h-5 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
              Quick Tips to Get Started
            </h4>
            <ul class="space-y-2 text-sm text-slate-600">
              <li class="flex items-start">
                <svg class="w-4 h-4 mr-2 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Create a project to organize related tasks together</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 mr-2 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Assign tasks to team members to track responsibilities</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 mr-2 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Set due dates and priorities to manage your workflow</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 mr-2 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Schedule meetings and invite team members to collaborate</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
  
  <!-- Sidebar -->
  <div class="space-y-4">
    <!-- Quick stats -->
    <div class="bg-white rounded-lg border border-slate-200 p-4">
      <h3 class="font-medium mb-3">Workspace Overview</h3>
      <div class="space-y-3">
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">Active Tasks</span>
          <span class="font-semibold text-blue-600">{{ stats.active_tasks }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">Completed This Week</span>
          <span class="font-semibold text-green-600">{{ stats.completed_week }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">Overdue</span>
          <span class="font-semibold text-red-600">{{ stats.overdue }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">Team Members</span>
          <span class="font-semibold">{{ stats.team_members }}</span>
        </div>
      </div>
    </div>
    
    <!-- Recent activity filters -->
    <div class="bg-white rounded-lg border border-slate-200 p-4">
      <h3 class="font-medium mb-3">Filter Activity</h3>
      <div class="space-y-2">
        <a href="/web/activity" class="block px-3 py-2 rounded hover:bg-slate-50 text-sm">
          All Activity
        </a>
        <a href="/web/activity?type=task" class="block px-3 py-2 rounded hover:bg-slate-50 text-sm">
          Tasks Only
        </a>
        <a href="/web/activity?type=comment" class="block px-3 py-2 rounded hover:bg-slate-50 text-sm">
          Comments
        </a>
        <a href="/web/activity?type=assignment" class="block px-3 py-2 rounded hover:bg-slate-50 text-sm">
          Assignments
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
