{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-semibold">My tasks</h1>
  <form method="get" class="flex items-center gap-2 text-sm">
    {% if is_admin %}
      <label>Assignee
        <select name="assignee_id" class="ml-1 rounded border border-slate-300 px-2 py-1">
          <option value="">All</option>
          {% for u in (users or []) %}
            <option value="{{ u.id }}" {% if selected and selected.assignee_id and selected.assignee_id|int == u.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
          {% endfor %}
        </select>
      </label>
    {% endif %}
    <label>Status
      <select name="status" class="ml-1 rounded border border-slate-300 px-2 py-1">
        <option value="">All</option>
        <option value="todo" {% if selected and selected.status == 'todo' %}selected{% endif %}>To Do</option>
        <option value="in_progress" {% if selected and selected.status == 'in_progress' %}selected{% endif %}>In Progress</option>
        <option value="blocked" {% if selected and selected.status == 'blocked' %}selected{% endif %}>Blocked</option>
        <option value="done" {% if selected and selected.status == 'done' %}selected{% endif %}>Done</option>
      </select>
    </label>
    <label>Project
      <select name="project_id" class="ml-1 rounded border border-slate-300 px-2 py-1">
        <option value="">All</option>
        {% for p in (projects or []) %}
          <option value="{{ p.id }}" {% if selected and selected.project_id and selected.project_id|int == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </label>
    <button class="px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50">Filter</button>
  </form>
  
</div>

{% if tasks %}
  <div class="overflow-x-auto rounded-lg border border-slate-200 bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-600">
        <tr>
          <th class="px-4 py-3 text-left font-medium">Title</th>
          {% if is_admin %}
          <th class="px-4 py-3 text-left font-medium">Assignees</th>
          {% endif %}
          <th class="px-4 py-3 text-left font-medium">Status</th>
          <th class="px-4 py-3 text-left font-medium">Priority</th>
          <th class="px-4 py-3 text-left font-medium">Due</th>
          <th class="px-4 py-3 text-left font-medium">Project</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        {% for t in tasks %}
        <tr>
          <td class="px-4 py-2">{{ t.title }}</td>
          {% if is_admin %}
          <td class="px-4 py-2">
            {% set names = assignees_map.get(t.id, []) %}
            {% if names %}
              {{ names | join(', ') }}
            {% else %}
              <span class="text-slate-400">Unassigned</span>
            {% endif %}
          </td>
          {% endif %}
          <td class="px-4 py-2">
            <span class="inline-flex items-center rounded px-2 py-1 text-xs bg-slate-100">{{ t.status }}</span>
          </td>
          <td class="px-4 py-2">{{ t.priority }}</td>
          <td class="px-4 py-2">{% if t.due_date %}{{ t.due_date.strftime('%d/%m/%Y') }}{% if t.due_time %} {{ t.due_time.strftime('%H:%M') }}{% endif %}{% endif %}</td>
          <td class="px-4 py-2">
            <a class="text-slate-700 hover:underline" href="/web/projects/{{ t.project_id }}">Open project</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="rounded-lg border border-dashed border-slate-300 p-8 text-center text-slate-500 bg-white">No tasks yet.</div>
{% endif %}
{% endblock %}
