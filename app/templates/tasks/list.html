{% extends "base.html" %}
{% block content %}
<div class="mb-5">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">All Tasks</h1>
      <p class="text-sm text-slate-500 mt-1">Complete list view of all workspace tasks</p>
    </div>
    <div class="flex items-center gap-2 overflow-x-auto">
      <a href="/web/tasks/list" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm whitespace-nowrap">
        List View
      </a>
      <a href="/web/projects" class="px-3 py-2 bg-slate-100 text-slate-700 rounded hover:bg-slate-200 text-sm whitespace-nowrap">
        Board View
      </a>
      <a href="/web/calendar" class="px-3 py-2 bg-slate-100 text-slate-700 rounded hover:bg-slate-200 text-sm whitespace-nowrap">
        Calendar View
      </a>
    </div>
  </div>
</div>

<!-- Status Tabs -->
<div class="mb-4 border-b border-slate-200 overflow-x-auto">
  <nav class="flex gap-4 min-w-max">
    <a href="/web/tasks/list?tab=active" 
       class="px-4 py-2 border-b-2 {% if selected.tab != 'done' %}border-blue-600 text-blue-600{% else %}border-transparent text-slate-600 hover:text-slate-900{% endif %} font-medium text-sm whitespace-nowrap">
      Active Tasks
    </a>
    <a href="/web/tasks/list?tab=done" 
       class="px-4 py-2 border-b-2 {% if selected.tab == 'done' %}border-blue-600 text-blue-600{% else %}border-transparent text-slate-600 hover:text-slate-900{% endif %} font-medium text-sm whitespace-nowrap">
      Done
    </a>
  </nav>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg border border-slate-200 p-4 mb-4">
  <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-3">
    <div>
      <label class="block text-xs font-medium mb-1 text-slate-600">Status</label>
      <select name="status" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
        <option value="">All Statuses</option>
        <option value="todo" {% if selected.status == 'todo' %}selected{% endif %}>To Do</option>
        <option value="in_progress" {% if selected.status == 'in_progress' %}selected{% endif %}>In Progress</option>
        <option value="blocked" {% if selected.status == 'blocked' %}selected{% endif %}>Blocked</option>
        <option value="done" {% if selected.status == 'done' %}selected{% endif %}>Done</option>
      </select>
    </div>
    
    <div>
      <label class="block text-xs font-medium mb-1 text-slate-600">Priority</label>
      <select name="priority" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
        <option value="">All Priorities</option>
        <option value="low" {% if selected.priority == 'low' %}selected{% endif %}>Low</option>
        <option value="medium" {% if selected.priority == 'medium' %}selected{% endif %}>Medium</option>
        <option value="high" {% if selected.priority == 'high' %}selected{% endif %}>High</option>
        <option value="critical" {% if selected.priority == 'critical' %}selected{% endif %}>Critical</option>
      </select>
    </div>
    
    <div>
      <label class="block text-xs font-medium mb-1 text-slate-600">Assignee</label>
      <select name="assignee_id" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
        <option value="">All Assignees</option>
        {% for user in users %}
          <option value="{{ user.id }}" {% if selected.assignee_id == user.id|string %}selected{% endif %}>
            {{ user.full_name or user.email }}
          </option>
        {% endfor %}
      </select>
    </div>
    
    <div>
      <label class="block text-xs font-medium mb-1 text-slate-600">Project</label>
      <select name="project_id" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
        <option value="">All Projects</option>
        {% for project in projects %}
          <option value="{{ project.id }}" {% if selected.project_id == project.id|string %}selected{% endif %}>
            {{ project.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="flex items-end">
      <button type="submit" class="w-full px-4 py-2 bg-slate-900 text-white rounded hover:bg-slate-800 text-sm">
        Apply Filters
      </button>
    </div>
  </form>
</div>

<!-- Desktop Table view -->
<div class="hidden md:block bg-white rounded-lg border border-slate-200 overflow-hidden">
  <table class="w-full">
    <thead class="bg-slate-50 border-b border-slate-200">
      <tr>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Project</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Task</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Status</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Priority</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Assignees</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Due Date</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase">Time</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-200">
      {% for task in tasks %}
        <tr class="hover:bg-slate-50 cursor-pointer" onclick="window.location='/web/tasks/{{ task.id }}'">
          <td class="px-4 py-3">
            <span class="text-sm text-slate-600">{{ project_names.get(task.id, 'Unknown') }}</span>
          </td>
          <td class="px-4 py-3">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="font-medium">{{ task.title }}</div>
              {% if task.is_archived %}
              <span style="padding: 0.125rem 0.5rem; background: #fbbf24; color: #78350f; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 600;">
                üóÑÔ∏è ARCHIVED
              </span>
              {% endif %}
            </div>
            {% if task.description %}
              <div class="text-sm text-slate-500 truncate max-w-md">{{ task.description[:80] }}...</div>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {% if task.status.value == 'done' %}
              <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Done</span>
            {% elif task.status.value == 'in_progress' %}
              <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">In Progress</span>
            {% elif task.status.value == 'blocked' %}
              <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">Blocked</span>
            {% else %}
              <span class="px-2 py-1 bg-slate-100 text-slate-800 text-xs rounded">To Do</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {% if task.priority.value == 'critical' %}
              <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">Critical</span>
            {% elif task.priority.value == 'high' %}
              <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded">High</span>
            {% elif task.priority.value == 'medium' %}
              <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Medium</span>
            {% else %}
              <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Low</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-1">
              {% if assignees_map.get(task.id) %}
                {% for assignee in assignees_map[task.id][:3] %}
                  <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs font-medium" title="{{ assignee }}">
                    {{ assignee[:1] }}
                  </div>
                {% endfor %}
                {% if assignees_map[task.id]|length > 3 %}
                  <span class="text-xs text-slate-500">+{{ assignees_map[task.id]|length - 3 }}</span>
                {% endif %}
              {% else %}
                <span class="text-sm text-slate-400">Unassigned</span>
              {% endif %}
            </div>
          </td>
          <td class="px-4 py-3">
            {% if task.due_date %}
              {% set is_overdue = task.due_date < today and task.status.value != 'done' %}
              <span class="text-sm {% if is_overdue %}text-red-600 font-medium{% endif %}">
                {{ task.due_date.strftime('%d/%m/%Y') }}
              </span>
            {% else %}
              <span class="text-sm text-slate-400">No date</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {% if task.estimated_hours %}
              <div class="text-sm">
                <span class="text-slate-500">{{ task.time_spent_hours or 0 }}h</span>
                <span class="text-slate-400">/</span>
                <span class="text-slate-600">{{ task.estimated_hours }}h</span>
              </div>
            {% else %}
              <span class="text-sm text-slate-400">-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      
      {% if not tasks %}
        <tr>
          <td colspan="7" class="px-4 py-12 text-center text-slate-500">
            No tasks found. <a href="/web/projects" class="text-blue-600 hover:underline">Create your first task</a>
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Mobile Card view -->
<div class="md:hidden space-y-3">
  {% if tasks %}
    {% for task in tasks %}
      <div class="bg-white rounded-lg border border-slate-200 p-4" onclick="window.location='/web/tasks/{{ task.id }}'" style="cursor: pointer;">
        <!-- Project name -->
        <div class="text-xs font-medium text-slate-500 mb-2">{{ project_names.get(task.id, 'Unknown') }}</div>
        
        <!-- Task title and archived badge -->
        <div class="flex items-start gap-2 mb-2">
          <div class="font-medium text-base flex-1">{{ task.title }}</div>
          {% if task.is_archived %}
          <span class="px-2 py-0.5 bg-amber-100 text-amber-800 text-xs rounded font-semibold whitespace-nowrap">
            üóÑÔ∏è ARCHIVED
          </span>
          {% endif %}
        </div>
        
        <!-- Description -->
        {% if task.description %}
          <div class="text-sm text-slate-500 mb-3 line-clamp-2">{{ task.description }}</div>
        {% endif %}
        
        <!-- Status and Priority badges -->
        <div class="flex items-center gap-2 mb-3">
          {% if task.status.value == 'done' %}
            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Done</span>
          {% elif task.status.value == 'in_progress' %}
            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">In Progress</span>
          {% elif task.status.value == 'blocked' %}
            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">Blocked</span>
          {% else %}
            <span class="px-2 py-1 bg-slate-100 text-slate-800 text-xs rounded">To Do</span>
          {% endif %}
          
          {% if task.priority.value == 'critical' %}
            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">Critical</span>
          {% elif task.priority.value == 'high' %}
            <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded">High</span>
          {% elif task.priority.value == 'medium' %}
            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Medium</span>
          {% else %}
            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Low</span>
          {% endif %}
        </div>
        
        <!-- Footer: Assignees, Due date, Time -->
        <div class="flex items-center justify-between text-xs text-slate-600">
          <div class="flex items-center gap-2">
            <!-- Assignees -->
            <div class="flex items-center gap-1">
              {% if assignees_map.get(task.id) %}
                {% for assignee in assignees_map[task.id][:2] %}
                  <div class="w-5 h-5 rounded-full bg-slate-200 flex items-center justify-center text-xs font-medium" title="{{ assignee }}">
                    {{ assignee[:1] }}
                  </div>
                {% endfor %}
                {% if assignees_map[task.id]|length > 2 %}
                  <span class="text-xs text-slate-500">+{{ assignees_map[task.id]|length - 2 }}</span>
                {% endif %}
              {% else %}
                <span class="text-xs text-slate-400">Unassigned</span>
              {% endif %}
            </div>
          </div>
          
          <!-- Due date and time -->
          <div class="flex items-center gap-3">
            {% if task.due_date %}
              {% set is_overdue = task.due_date < today and task.status.value != 'done' %}
              <span class="{% if is_overdue %}text-red-600 font-medium{% endif %}">
                üìÖ {{ task.due_date.strftime('%d/%m/%Y') }}
              </span>
            {% endif %}
            
            {% if task.estimated_hours %}
              <span class="text-slate-500">
                ‚è±Ô∏è {{ task.time_spent_hours or 0 }}/{{ task.estimated_hours }}h
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="bg-white rounded-lg border border-slate-200 p-8 text-center text-slate-500">
      No tasks found. <a href="/web/projects" class="text-blue-600 hover:underline">Create your first task</a>
    </div>
  {% endif %}
</div>

<div class="mt-4 text-sm text-slate-500">
  Showing {{ tasks|length }} task{{ 's' if tasks|length != 1 else '' }}
</div>
{% endblock %}
