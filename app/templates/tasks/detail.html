{% extends "base.html" %}
{% block content %}
<div style="margin-bottom: 1rem;">
  <a href="/web/projects/{{ project.id }}" style="color: #2563eb;" class="text-sm sm:text-base">‚Üê Back to {{ project.name }}</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
  <div class="lg:col-span-2">
    <div class="bg-white border border-slate-200 rounded p-3 sm:p-4">
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h2 class="text-lg sm:text-xl font-semibold" style="margin: 0; flex: 1; min-width: 0; word-break: break-word;">{{ task.title }}</h2>
        {% if task.is_archived %}
        <span style="padding: 0.25rem 0.75rem; background: #fbbf24; color: #78350f; border-radius: 0.375rem; font-size: 0.75rem; sm:font-size: 0.875rem; font-weight: 600; white-space: nowrap;">
          üóÑÔ∏è ARCHIVED
        </span>
        {% endif %}
      </div>
      
      {% if task.is_archived and not user.is_admin %}
      <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; color: #78350f;">
        ‚ö†Ô∏è This task is archived and read-only. Only admins can modify or reopen it.
      </div>
      {% endif %}
      
      {% if task.is_archived and user.is_admin %}
      <div style="background: #dbeafe; border: 1px solid #3b82f6; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
        <form method="post" action="/web/tasks/{{ task.id }}/reopen" style="display: flex; justify-content: space-between; align-items: center;">
          <span style="color: #1e40af;">This task is archived. You can reopen it to move it back to the board.</span>
          <button type="submit" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
            üîì Reopen Task
          </button>
        </form>
      </div>
      {% endif %}
      
      <!-- Task Info -->
      <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
        <p><strong>Status:</strong> {{ task.status.value.replace('_', ' ').title() }}</p>
        <p><strong>Priority:</strong> {{ task.priority.value.title() }}</p>
        {% if task.start_date %}<p><strong>Start:</strong> {{ task.start_date.strftime('%d/%m/%Y') }}{% if task.start_time %} {{ task.start_time.strftime('%H:%M') }}{% endif %}</p>{% endif %}
        {% if task.due_date %}<p><strong>Due:</strong> {{ task.due_date.strftime('%d/%m/%Y') }}{% if task.due_time %} {{ task.due_time.strftime('%H:%M') }}{% endif %}</p>{% endif %}
        {% if assignments %}
        <p><strong>Assigned to:</strong> 
          {% for a in assignments %}{{ a.full_name or a.username }}{% if not loop.last %}, {% endif %}{% endfor %}
        </p>
        {% endif %}
      </div>

      {% if task.description %}
      <div style="margin-bottom: 1rem;">
        <h3>Description</h3>
        <p style="white-space: pre-wrap;">{{ task.description }}</p>
      </div>
      {% endif %}

      {% set is_assigned = namespace(value=false) %}
      {% for a in assignments %}
        {% if a.id == user.id %}
          {% set is_assigned.value = true %}
        {% endif %}
      {% endfor %}
      
      {% if (user.is_admin or is_assigned.value) and not (task.is_archived and not user.is_admin) %}
      <details style="margin-bottom: 1.5rem;">
        <summary style="cursor: pointer; font-weight: bold;">‚úèÔ∏è Edit Task</summary>
        <form method="post" action="/web/tasks/{{ task.id }}/update" class="space-y-3" style="margin-top: 1rem;">
          <label>Title <input name="title" value="{{ task.title }}" required /></label>
          <label>Description <textarea name="description" rows="5">{{ task.description or '' }}</textarea></label>
          
          <div class="grid grid-cols-2 gap-3">
            <label>
              Status
              <select name="status" required>
                {% for s in TaskStatus %}
                <option value="{{ s.value }}" {% if s == task.status %}selected{% endif %}>{{ s.value.replace('_',' ').title() }}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              Priority
              <select name="priority" required>
                {% for p in TaskPriority %}
                <option value="{{ p.value }}" {% if task.priority and p == task.priority %}selected{% endif %}>{{ p.value.title() }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <label>Start Date <input type="date" name="start_date_value" value="{{ task.start_date.strftime('%Y-%m-%d') if task.start_date else '' }}" /></label>
            <label>Start Time <input type="time" name="start_time_value" value="{{ task.start_time.strftime('%H:%M') if task.start_time else '' }}" /></label>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <label>Due Date <input type="date" name="due_date_value" value="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}" /></label>
            <label>Due Time <input type="time" name="due_time_value" value="{{ task.due_time.strftime('%H:%M') if task.due_time else '' }}" /></label>
          </div>

          <button type="submit">üíæ Save Changes</button>
        </form>
      </details>
      {% endif %}
    </div>

    <!-- Subtasks Section -->
    <div class="bg-white border border-slate-200 rounded p-4 mt-6">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 class="text-base font-semibold" style="margin: 0;">‚úÖ Subtasks</h3>
        {% if total_subtasks > 0 %}
        <span id="subtask-counter" style="font-size: 0.875rem; color: #64748b;">
          {{ completed_subtasks }}/{{ total_subtasks }} ({{ completion_percentage }}%)
        </span>
        {% endif %}
      </div>

      <!-- Progress Bar -->
      {% if total_subtasks > 0 %}
      <div id="subtask-progress-container" style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 1rem; overflow: hidden;">
        <div id="subtask-progress-bar" style="background: #10b981; height: 100%; width: {{ completion_percentage }}%; transition: width 0.3s;"></div>
      </div>
      {% endif %}

      <!-- Subtask List -->
      {% if subtasks %}
      <div style="margin-bottom: 1.5rem;">
        {% for subtask in subtasks %}
        <div class="subtask-item" data-subtask-id="{{ subtask.id }}" style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e2e8f0; gap: 0.75rem;">
          <input 
            type="checkbox" 
            class="subtask-checkbox" 
            {% if subtask.is_completed %}checked{% endif %}
            {% if task.is_archived and not user.is_admin %}disabled{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;"
            onchange="toggleSubtask({{ task.id }}, {{ subtask.id }})"
          />
          <span class="subtask-title" style="flex: 1; {% if subtask.is_completed %}text-decoration: line-through; color: #94a3b8;{% endif %}">
            {{ subtask.title }}
          </span>
          {% if subtask.completed_at %}
          <span style="font-size: 0.75rem; color: #64748b;">
            ‚úì {{ subtask.completed_at.strftime('%b %d, %H:%M') }}
          </span>
          {% endif %}
          {% if (user.is_admin or is_assigned.value) and not (task.is_archived and not user.is_admin) %}
          <button 
            onclick="deleteSubtask({{ task.id }}, {{ subtask.id }})" 
            style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;"
            title="Delete subtask"
          >
            üóëÔ∏è
          </button>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1.5rem;">No subtasks yet. Add some to break down this task!</p>
      {% endif %}

      <!-- Add Subtasks Form -->
      {% if (user.is_admin or is_assigned.value) and not (task.is_archived and not user.is_admin) %}
      <details>
        <summary style="cursor: pointer; font-weight: 500; color: #3b82f6; margin-bottom: 0.5rem;">‚ûï Add Subtasks</summary>
        <form method="post" action="/web/tasks/{{ task.id }}/subtasks" style="margin-top: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Enter subtasks (one per line):
          </label>
          <textarea 
            name="subtasks" 
            rows="5" 
            placeholder="Fix login bug&#10;Update documentation&#10;Add unit tests&#10;Code review"
            style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.875rem;"
            required
          ></textarea>
          <button 
            type="submit" 
            style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;"
          >
            ‚ûï Add Subtasks
          </button>
        </form>
      </details>
      {% endif %}
    </div>

    <div class="bg-white border border-slate-200 rounded p-4 mt-6">
      <h3 class="text-base font-semibold mb-3">üí¨ Comments ({{ comments|length }})</h3>
      {% if not task.is_archived or user.is_admin %}
      <form method="post" action="/web/tasks/{{ task.id }}/comment" class="mb-4" enctype="multipart/form-data">
        <textarea name="content" rows="3" required placeholder="Write a comment..."></textarea>
        
        <!-- File Upload Section -->
        <div style="margin-top: 0.75rem; margin-bottom: 0.75rem;">
          <label for="attachments-{{ task.id }}" style="display: inline-block; padding: 0.5rem 1rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
            üìé Add Attachments
          </label>
          <input type="file" id="attachments-{{ task.id }}" name="files" multiple style="display: none;" onchange="updateFileList(this, 'file-list-{{ task.id }}')">
          <div id="file-list-{{ task.id }}" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></div>
        </div>
        
        <div class="pt-2 text-right">
          <button type="submit">Post Comment</button>
        </div>
      </form>
      {% else %}
      <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; color: #78350f; text-align: center;">
        üîí This task is archived. Only admins can add comments.
      </div>
      {% endif %}
      
      <div class="space-y-3">
        {% for comment, author in comments %}
        <div style="border-left: 3px solid #2563eb; padding: 0.75rem; background: #f9fafb; border-radius: 0.25rem; margin-bottom: 0.75rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <strong>{{ author.full_name or author.username }}</strong>
            <span style="color: #6b7280; font-size: 0.875rem;">{{ utc_to_local(comment.created_at).strftime('%d/%m/%Y %H:%M') }}</span>
          </div>
          <p style="white-space: pre-wrap; margin: 0;">{{ comment.content }}</p>
          
          <!-- Display attachments if any -->
          {% if attachments_by_comment and attachments_by_comment.get(comment.id) %}
          <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">üìé Attachments:</div>
            {% for attachment in attachments_by_comment[comment.id] %}
            <div style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; margin-right: 0.5rem; margin-bottom: 0.5rem; background: white; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.875rem;">
              <span style="color: #374151;">üìÑ {{ attachment.filename }} ({{ (attachment.file_size / 1024) | round(1) }} KB)</span>
              <button onclick="previewAttachment({{ attachment.id }}, '{{ attachment.filename | replace("'", "\\'") }}', '{{ attachment.content_type }}')" 
                      style="padding: 0.125rem 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                üëÅÔ∏è Preview
              </button>
              <a href="/web/attachments/{{ attachment.id }}/download" 
                 style="padding: 0.125rem 0.5rem; background: #10b981; color: white; border-radius: 0.25rem; text-decoration: none; font-size: 0.75rem;">
                ‚¨áÔ∏è Download
              </a>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% else %}
        <div class="text-sm text-slate-500">No comments yet. Be the first to comment!</div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; padding: 2rem;">
      <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; background: white; border-radius: 0.5rem; overflow: hidden;">
        <!-- Modal Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
          <h3 id="previewTitle" style="margin: 0; font-size: 1rem; font-weight: 600;">Preview</h3>
          <button onclick="closePreview()" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
            ‚úï Close
          </button>
        </div>
        <!-- Modal Content -->
        <div id="previewContent" style="flex: 1; overflow: auto; padding: 1rem; display: flex; justify-content: center; align-items: center;">
          <p style="color: #6b7280;">Loading preview...</p>
        </div>
      </div>
    </div>

    <script>
    function updateFileList(input, listId) {
      const fileList = document.getElementById(listId);
      if (input.files.length > 0) {
        const files = Array.from(input.files).map(f => f.name).join(', ');
        fileList.textContent = `Selected: ${files}`;
      } else {
        fileList.textContent = '';
      }
    }

    function previewAttachment(attachmentId, filename, contentType) {
      const modal = document.getElementById('previewModal');
      const title = document.getElementById('previewTitle');
      const content = document.getElementById('previewContent');
      
      title.textContent = filename;
      modal.style.display = 'block';
      
      // Determine how to preview based on content type
      const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
      const pdfType = 'application/pdf';
      const textTypes = ['text/plain', 'text/html', 'text/css', 'text/javascript', 'application/json', 'application/xml'];
      
      const previewUrl = `/web/attachments/${attachmentId}/preview`;
      const downloadUrl = `/web/attachments/${attachmentId}/download`;
      
      if (imageTypes.includes(contentType)) {
        // Image preview
        content.innerHTML = `<img src="${previewUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="${filename}">`;
      } else if (contentType === pdfType) {
        // PDF preview
        content.innerHTML = `<iframe src="${previewUrl}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      } else if (textTypes.includes(contentType) || contentType.startsWith('text/')) {
        // Text file preview
        fetch(previewUrl)
          .then(response => response.text())
          .then(text => {
            content.innerHTML = `<pre style="width: 100%; height: 100%; overflow: auto; margin: 0; padding: 1rem; background: #1f2937; color: #f3f4f6; border-radius: 0.375rem; font-family: monospace; font-size: 0.875rem;">${escapeHtml(text)}</pre>`;
          })
          .catch(error => {
            content.innerHTML = `<p style="color: #ef4444;">Error loading preview: ${error.message}</p>`;
          });
      } else if (contentType.startsWith('video/')) {
        // Video preview
        content.innerHTML = `<video controls style="max-width: 100%; max-height: 100%;">
          <source src="${previewUrl}" type="${contentType}">
          Your browser does not support video playback.
        </video>`;
      } else if (contentType.startsWith('audio/')) {
        // Audio preview
        content.innerHTML = `<div style="text-align: center;">
          <p style="margin-bottom: 1rem; color: #374151;">üéµ ${filename}</p>
          <audio controls style="width: 100%; max-width: 500px;">
            <source src="${previewUrl}" type="${contentType}">
            Your browser does not support audio playback.
          </audio>
        </div>`;
      } else {
        // Unsupported file type - offer download
        content.innerHTML = `<div style="text-align: center;">
          <p style="color: #6b7280; margin-bottom: 1rem;">Preview not available for this file type.</p>
          <p style="color: #6b7280; margin-bottom: 1rem;">File type: ${contentType}</p>
          <a href="${downloadUrl}" style="display: inline-block; padding: 0.75rem 1.5rem; background: #10b981; color: white; text-decoration: none; border-radius: 0.375rem; font-weight: 500;">
            ‚¨áÔ∏è Download File
          </a>
        </div>`;
      }
    }

    function closePreview() {
      const modal = document.getElementById('previewModal');
      modal.style.display = 'none';
      document.getElementById('previewContent').innerHTML = '<p style="color: #6b7280;">Loading preview...</p>';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modal when clicking outside
    document.getElementById('previewModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closePreview();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closePreview();
      }
    });
    </script>
  </div>

  <div>
    <div class="bg-white border border-slate-200 rounded p-4">
      <h3 class="text-base font-semibold mb-3">üìú Edit History</h3>
      <div style="max-height: 600px; overflow-y: auto;">
        {% for history_entry, editor in history %}
        <div style="border-left: 2px solid #e5e7eb; padding-left: 0.75rem; margin-bottom: 1rem;">
          <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">
            {{ utc_to_local(history_entry.created_at).strftime('%d/%m/%Y %H:%M') }}
          </div>
          <div style="font-weight: 500; margin-bottom: 0.25rem;">
            {{ editor.full_name or editor.username }}
          </div>
          <div style="font-size: 0.875rem;">
            Changed <strong>{{ history_entry.field.replace('_', ' ') }}</strong>
            {% if history_entry.old_value %}
            <div style="color: #dc2626; margin-top: 0.25rem;">
              <strong>From:</strong> {{ history_entry.old_value }}
            </div>
            {% endif %}
            {% if history_entry.new_value %}
            <div style="color: #059669; margin-top: 0.25rem;">
              <strong>To:</strong> {{ history_entry.new_value }}
            </div>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="text-sm text-slate-500">No edit history yet.</div>
        {% endfor %}
      </div>
    </div>

    <div class="bg-white border border-slate-200 rounded p-4 mt-4">
      <h3 class="text-base font-semibold mb-3">‚ö° Quick Actions</h3>
      <a href="/web/calendar" style="display: block; margin-bottom: 0.5rem;">üìÖ View Calendar</a>
      <a href="/web/my-tasks" style="display: block; margin-bottom: 0.5rem;">üìã My Tasks</a>
      <a href="/web/projects/{{ project.id }}" style="display: block;">üìÇ Back to Project</a>
    </div>
  </div>
</div>

<script>
// Toggle subtask completion
async function toggleSubtask(taskId, subtaskId) {
  try {
    const response = await fetch(`/web/tasks/${taskId}/subtasks/${subtaskId}/toggle`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Update UI
      const subtaskItem = document.querySelector(`.subtask-item[data-subtask-id="${subtaskId}"]`);
      const titleSpan = subtaskItem.querySelector('.subtask-title');
      const checkbox = subtaskItem.querySelector('.subtask-checkbox');
      
      if (data.is_completed) {
        titleSpan.style.textDecoration = 'line-through';
        titleSpan.style.color = '#94a3b8';
      } else {
        titleSpan.style.textDecoration = 'none';
        titleSpan.style.color = 'inherit';
      }
      
      // Update progress
      updateProgress(data.completed_subtasks, data.total_subtasks, data.completion_percentage);
    } else {
      alert('Failed to toggle subtask');
      // Revert checkbox
      const checkbox = document.querySelector(`.subtask-item[data-subtask-id="${subtaskId}"] .subtask-checkbox`);
      checkbox.checked = !checkbox.checked;
    }
  } catch (error) {
    console.error('Error toggling subtask:', error);
    alert('An error occurred');
    // Revert checkbox
    const checkbox = document.querySelector(`.subtask-item[data-subtask-id="${subtaskId}"] .subtask-checkbox`);
    checkbox.checked = !checkbox.checked;
  }
}

// Delete subtask
async function deleteSubtask(taskId, subtaskId) {
  if (!confirm('Are you sure you want to delete this subtask?')) {
    return;
  }
  
  try {
    const response = await fetch(`/web/tasks/${taskId}/subtasks/${subtaskId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Remove from UI
      const subtaskItem = document.querySelector(`.subtask-item[data-subtask-id="${subtaskId}"]`);
      subtaskItem.remove();
      
      // Reload page to update counts
      location.reload();
    } else {
      alert('Failed to delete subtask');
    }
  } catch (error) {
    console.error('Error deleting subtask:', error);
    alert('An error occurred');
  }
}

// Update progress display
function updateProgress(completed, total, percentage) {
  // Update counter text
  const counter = document.getElementById('subtask-counter');
  if (counter) {
    counter.textContent = `${completed}/${total} (${percentage}%)`;
  }
  
  // Update progress bar
  const progressBar = document.getElementById('subtask-progress-bar');
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
}
</script>
{% endblock %}
