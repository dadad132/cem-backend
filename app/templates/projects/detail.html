{% extends 'base.html' %}
{% block content %}
<div class="mb-5 flex items-start justify-between">
  <div>
    <h1 class="text-2xl font-semibold">{{ project.name }}</h1>
    {% if project.description %}<p class="text-slate-500">{{ project.description }}</p>{% endif %}
  </div>
  {% if user is defined and user.is_admin %}
  <a href="/web/projects/{{ project.id }}/members" 
     class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
    Manage Members
  </a>
  {% endif %}
</div>

<div class="mb-4">
  <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded text-sm text-blue-800 mb-4">
    <strong>‚ÑπÔ∏è Note:</strong> Completed tasks are automatically archived and hidden from this board.
    <a href="/web/tasks/list?project_id={{ project.id }}&tab=done" class="underline font-medium">View all tasks including archived ‚Üí</a>
  </div>
  <form method="post" action="/web/tasks/create" class="grid grid-cols-1 lg:grid-cols-6 gap-2 items-end">
    <input type="hidden" name="project_id" value="{{ project.id }}" />
    <div class="lg:col-span-2">
      <label class="block text-xs mb-1">Title</label>
      <input class="w-full rounded border border-slate-300 px-3 py-2 text-sm" type="text" name="title" placeholder="Task title" required />
    </div>
    <div class="lg:col-span-2">
      <label class="block text-xs mb-1">Description</label>
      <input class="w-full rounded border border-slate-300 px-3 py-2 text-sm" type="text" name="description" placeholder="Optional description" />
    </div>
    <div class="lg:col-span-6">
      <label class="block text-xs mb-1">Subtasks (optional - one per line)</label>
      <textarea class="w-full rounded border border-slate-300 px-3 py-2 text-sm" name="subtasks" rows="3" placeholder="Bug fix login page&#10;Update documentation&#10;Add unit tests"></textarea>
    </div>
    <div>
      <label class="block text-xs mb-1">Priority</label>
      <select name="priority" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" required>
        <option value="low">‚¨áÔ∏è Low</option>
        <option value="medium" selected>‚û°Ô∏è Medium</option>
        <option value="high">‚¨ÜÔ∏è High</option>
        <option value="critical">üî• Critical</option>
      </select>
    </div>
    <div>
      <label class="block text-xs mb-1">Start date</label>
      <input name="start_date_value" type="date" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs mb-1">Start time</label>
      <input name="start_time_value" type="time" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs mb-1">Due date</label>
      <input name="due_date_value" type="date" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs mb-1">Due time</label>
      <input name="due_time_value" type="time" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <button type="submit" class="px-3 py-2 rounded bg-slate-900 text-white text-sm">Add task</button>
    </div>
  </form>
</div>

<div class="grid grid-cols-4 gap-4">
  {% set cols = [
    ("todo", "To Do", columns[TaskStatus.todo], "bg-slate-100"),
    ("in_progress", "In Progress", columns[TaskStatus.in_progress], "bg-amber-100"),
    ("done", "Done", columns[TaskStatus.done], "bg-emerald-100"),
    ("blocked", "Blocked", columns[TaskStatus.blocked], "bg-rose-100"),
  ] %}

  {% for key, label, items, color in cols %}
    <section class="rounded-xl border border-slate-200 bg-white p-3 flex flex-col">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium">{{ label }}</h3>
        <span class="text-xs text-slate-500">{{ items|length }}</span>
      </div>
      <div id="col-{{ key }}" class="flex-1 min-h-[200px] rounded {{ color }}/50 p-2 space-y-2 overflow-y-auto scrollbar-thin">
        {% for t in items %}
          <article class="task-card rounded-lg border border-slate-200 bg-white p-3 shadow-sm" data-task-id="{{ t.id }}">
            <div class="flex items-start justify-between gap-2">
              <a href="/web/tasks/{{ t.id }}" class="text-sm font-medium hover:underline">{{ t.title }}</a>
              <div class="flex items-center gap-2">
                {% if t.priority %}
                  {% set chip = {'low':'bg-emerald-100 text-emerald-800','medium':'bg-sky-100 text-sky-800','high':'bg-amber-100 text-amber-800','critical':'bg-rose-100 text-rose-800'}[t.priority.value] %}
                  <span class="text-[10px] px-2 py-0.5 rounded {{ chip }}">{{ t.priority.value.title() }}</span>
                {% endif %}
                {% if t.due_date %}
                  <span class="text-[10px] px-2 py-0.5 rounded border border-slate-200">
                    {% if t.due_date is string %}
                      {{ t.due_date }}
                    {% else %}
                      {{ t.due_date.strftime('%d/%m/%Y') }}
                    {% endif %}
                    {% if t.due_time %} {{ t.due_time.strftime('%H:%M') if t.due_time.strftime else t.due_time }}{% endif %}
                  </span>
                {% endif %}
              </div>
            </div>
            {% if t.description %}<div class="text-xs text-slate-500 mt-1">{{ t.description }}</div>{% endif %}
            {% set asgs = assignees_map.get(t.id, []) %}
            <div class="mt-2 flex items-center justify-between gap-2">
              <div class="flex items-center gap-1">
                {% if asgs %}
                  {% for name, email in asgs %}
                    {% set initials = (name.split()[0][:1] ~ (name.split()[1][:1] if name.split()|length > 1 else '')).upper() %}
                    <div class="w-6 h-6 rounded-full bg-slate-200 text-[10px] font-medium text-slate-700 flex items-center justify-center" title="{{ name }}">{{ initials }}</div>
                  {% endfor %}
                {% else %}
                  <span class="text-[11px] text-slate-400">Unassigned</span>
                {% endif %}
              </div>
              {% if user is defined and user.is_admin %}
              <form method="post" action="/web/tasks/{{ t.id }}/delete" onsubmit="return confirm('Delete task \'{{ t.title }}\'?');" class="inline">
                <button type="submit" class="text-red-600 hover:text-red-700 p-1" title="Delete task">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </form>
              {% endif %}
            </div>
            {% if user is defined and user.is_admin %}
            <div class="mt-2">
              <form method="post" action="/web/tasks/{{ t.id }}/assign" class="flex items-center gap-2">
                <select name="assignee_id" class="text-[11px] rounded border border-slate-300 px-2 py-1">
                  {% for u in users %}
                    <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
                  {% endfor %}
                </select>
                <button class="text-[11px] px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">Assign</button>
              </form>
              <form method="post" action="/web/tasks/{{ t.id }}/unassign" class="mt-1 flex items-center gap-2">
                <select name="assignee_id" class="text-[11px] rounded border border-slate-300 px-2 py-1">
                  {% for u in users %}
                    <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
                  {% endfor %}
                </select>
                <button class="text-[11px] px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">Unassign</button>
              </form>
            </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    </section>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
  const statuses = ["todo", "in_progress", "blocked", "done"]; 
  const lists = statuses.map(s => document.getElementById(`col-${s}`));
  lists.forEach(list => new Sortable(list, {
    group: 'kanban', animation: 150, ghostClass: 'opacity-60',
    onEnd: async (evt) => {
      const el = evt.item; // dragged element
      const taskId = el.dataset.taskId;
      const newCol = evt.to.id.replace('col-', '');
      const form = new FormData();
      form.append('status_value', newCol);
      try {
        const res = await fetch(`/web/tasks/${taskId}/status`, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Failed to update status');
      } catch (e) {
        // revert on fail
        evt.from.insertBefore(el, evt.from.children[evt.oldIndex]);
        alert('Could not update status');
      }
    }
  }));
</script>
{% endblock %}
