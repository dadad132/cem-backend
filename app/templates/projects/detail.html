{% extends 'base.html' %}
{% block content %}
<div class="mb-5 flex items-start justify-between">
  <div>
    <h1 class="text-2xl font-semibold">{{ project.name }}</h1>
    {% if project.description %}<p class="text-slate-500">{{ project.description }}</p>{% endif %}
  </div>
  {% if user is defined and user.is_admin %}
  <a href="/web/projects/{{ project.id }}/members" 
     class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
    Manage Members
  </a>
  {% endif %}
</div>

<div class="mb-4">
  <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded text-sm text-blue-800 mb-4">
    <strong>‚ÑπÔ∏è Note:</strong> Completed tasks are automatically archived and hidden from this board.
    <a href="/web/tasks/list?project_id={{ project.id }}&tab=done" class="underline font-medium">View all tasks including archived ‚Üí</a>
  </div>
  <form method="post" action="/web/tasks/create" class="grid grid-cols-1 lg:grid-cols-6 gap-2 items-end">
    <input type="hidden" name="project_id" value="{{ project.id }}" />
    <div class="lg:col-span-2">
      <label class="block text-xs mb-1">Title</label>
      <input class="w-full rounded border border-slate-300 px-3 py-2 text-sm" type="text" name="title" placeholder="Task title" required />
    </div>
    <div class="lg:col-span-2">
      <label class="block text-xs mb-1">Description</label>
      <input class="w-full rounded border border-slate-300 px-3 py-2 text-sm" type="text" name="description" placeholder="Optional description" />
    </div>
    <div class="lg:col-span-6">
      <label class="block text-xs mb-1">Subtasks (optional - one per line)</label>
      <textarea class="w-full rounded border border-slate-300 px-3 py-2 text-sm" name="subtasks" rows="3" placeholder="Bug fix login page&#10;Update documentation&#10;Add unit tests"></textarea>
    </div>
    <div>
      <label class="block text-xs mb-1">Priority</label>
      <select name="priority" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" required>
        <option value="low">‚¨áÔ∏è Low</option>
        <option value="medium" selected>‚û°Ô∏è Medium</option>
        <option value="high">‚¨ÜÔ∏è High</option>
        <option value="critical">üî• Critical</option>
      </select>
    </div>
    <div>
      <label class="block text-xs mb-1">Start date</label>
      <input name="start_date_value" id="task-start-date" type="date" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs mb-1">Start time</label>
      <input name="start_time_value" type="time" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs mb-1">Due date</label>
      <input name="due_date_value" type="date" id="task-due-date" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs mb-1">Due time</label>
      <input name="due_time_value" type="time" class="w-full rounded border border-slate-300 px-3 py-2 text-sm" />
    </div>
    <div class="lg:col-span-6">
      <label class="block text-xs mb-1">Working Days (for date calculation)</label>
      <div class="flex flex-wrap gap-3">
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="0" checked class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Mon</span>
        </label>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="1" checked class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Tue</span>
        </label>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="2" checked class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Wed</span>
        </label>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="3" checked class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Thu</span>
        </label>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="4" checked class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Fri</span>
        </label>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="5" class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Sat</span>
        </label>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer">
          <input type="checkbox" name="working_days" value="6" class="working-day-check rounded border-slate-300" data-target="task-due-date" data-start="task-start-date" />
          <span>Sun</span>
        </label>
      </div>
      <p class="text-[10px] text-slate-500 mt-1">Select your working days. Due date will adjust to skip non-working days.</p>
    </div>
    <div class="lg:col-span-6">
      <label class="block text-xs mb-1">Duration (working days)</label>
      <div class="flex items-center gap-2">
        <input type="number" name="duration_days" id="task-duration" min="1" placeholder="e.g. 5" 
               class="w-24 rounded border border-slate-300 px-3 py-2 text-sm" 
               data-target="task-due-date" data-start="task-start-date" />
        <span class="text-xs text-slate-500">days ‚Üí auto-calculates due date</span>
      </div>
    </div>
    <div>
      <button type="submit" class="px-3 py-2 rounded bg-slate-900 text-white text-sm">Add task</button>
    </div>
  </form>
</div>

<div class="grid grid-cols-4 gap-4">
  {% set cols = [
    ("todo", "To Do", columns[TaskStatus.todo], "bg-slate-100"),
    ("in_progress", "In Progress", columns[TaskStatus.in_progress], "bg-amber-100"),
    ("done", "Done", columns[TaskStatus.done], "bg-emerald-100"),
    ("blocked", "Blocked", columns[TaskStatus.blocked], "bg-rose-100"),
  ] %}

  {% for key, label, items, color in cols %}
    <section class="rounded-xl border border-slate-200 bg-white p-3 flex flex-col">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium">{{ label }}</h3>
        <span class="text-xs text-slate-500">{{ items|length }}</span>
      </div>
      <div id="col-{{ key }}" class="flex-1 min-h-[200px] rounded {{ color }}/50 p-2 space-y-2 overflow-y-auto scrollbar-thin">
        {% for t in items %}
          <article class="task-card rounded-lg border border-slate-200 bg-white p-3 shadow-sm" data-task-id="{{ t.id }}">
            <div class="flex items-start justify-between gap-2">
              <a href="/web/tasks/{{ t.id }}" class="text-sm font-medium hover:underline">{{ t.title }}</a>
              <div class="flex items-center gap-2">
                {% if t.priority %}
                  {% set chip = {'low':'bg-emerald-100 text-emerald-800','medium':'bg-sky-100 text-sky-800','high':'bg-amber-100 text-amber-800','critical':'bg-rose-100 text-rose-800'}[t.priority.value] %}
                  <span class="text-[10px] px-2 py-0.5 rounded {{ chip }}">{{ t.priority.value.title() }}</span>
                {% endif %}
                {% if t.due_date %}
                  <span class="text-[10px] px-2 py-0.5 rounded border border-slate-200">
                    {% if t.due_date is string %}
                      {{ t.due_date }}
                    {% else %}
                      {{ t.due_date.strftime('%d/%m/%Y') }}
                    {% endif %}
                    {% if t.due_time %} {{ t.due_time.strftime('%H:%M') if t.due_time.strftime else t.due_time }}{% endif %}
                  </span>
                {% endif %}
              </div>
            </div>
            {% if t.description %}<div class="text-xs text-slate-500 mt-1">{{ t.description }}</div>{% endif %}
            {% set asgs = assignees_map.get(t.id, []) %}
            <div class="mt-2 flex items-center justify-between gap-2">
              <div class="flex items-center gap-1">
                {% if asgs %}
                  {% for name, email in asgs %}
                    {% set initials = (name.split()[0][:1] ~ (name.split()[1][:1] if name.split()|length > 1 else '')).upper() %}
                    <div class="w-6 h-6 rounded-full bg-slate-200 text-[10px] font-medium text-slate-700 flex items-center justify-center" title="{{ name }}">{{ initials }}</div>
                  {% endfor %}
                {% else %}
                  <span class="text-[11px] text-slate-400">Unassigned</span>
                {% endif %}
              </div>
            </div>
            {% if user is defined and user.is_admin %}
            <div class="mt-2">
              <form method="post" action="/web/tasks/{{ t.id }}/assign" class="flex items-center gap-2">
                <select name="assignee_id" class="text-[11px] rounded border border-slate-300 px-2 py-1">
                  {% for u in users %}
                    <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
                  {% endfor %}
                </select>
                <button class="text-[11px] px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">Assign</button>
              </form>
              <form method="post" action="/web/tasks/{{ t.id }}/unassign" class="mt-1 flex items-center gap-2">
                <select name="assignee_id" class="text-[11px] rounded border border-slate-300 px-2 py-1">
                  {% for u in users %}
                    <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
                  {% endfor %}
                </select>
                <button class="text-[11px] px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">Unassign</button>
              </form>
            </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    </section>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
  const statuses = ["todo", "in_progress", "blocked", "done"]; 
  const lists = statuses.map(s => document.getElementById(`col-${s}`));
  lists.forEach(list => new Sortable(list, {
    group: 'kanban', animation: 150, ghostClass: 'opacity-60',
    onEnd: async (evt) => {
      const el = evt.item; // dragged element
      const taskId = el.dataset.taskId;
      const newCol = evt.to.id.replace('col-', '');
      const form = new FormData();
      form.append('status_value', newCol);
      try {
        const res = await fetch(`/web/tasks/${taskId}/status`, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Failed to update status');
      } catch (e) {
        // revert on fail
        evt.from.insertBefore(el, evt.from.children[evt.oldIndex]);
        alert('Could not update status');
      }
    }
  }));

  // Working days date calculator
  // Note: We use Python weekday convention: Mon=0, Tue=1, ... Sun=6
  // JavaScript getDay() returns: Sun=0, Mon=1, ... Sat=6
  // So we convert JS day to Python day: (jsDay + 6) % 7
  function jsDayToPythonDay(jsDay) {
    return (jsDay + 6) % 7;
  }
  
  function calculateDueDate(startDateId, durationId, targetDateId, checkboxSelector) {
    const startInput = document.getElementById(startDateId);
    const durationInput = document.getElementById(durationId);
    const targetInput = document.getElementById(targetDateId);
    
    if (!startInput || !durationInput || !targetInput) return;
    
    const startDate = startInput.value;
    const duration = parseInt(durationInput.value);
    
    if (!startDate || !duration || duration < 1) return;
    
    // Get selected working days (Python convention: 0=Mon, 1=Tue, ..., 6=Sun)
    const checkboxes = document.querySelectorAll(checkboxSelector + ':checked');
    const workingDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (workingDays.length === 0) {
      alert('Please select at least one working day');
      return;
    }
    
    // Calculate due date
    let currentDate = new Date(startDate);
    let daysAdded = 0;
    
    // Start counting from start date if it's a working day
    const startPythonDay = jsDayToPythonDay(currentDate.getDay());
    if (workingDays.includes(startPythonDay)) {
      daysAdded = 1;
    }
    
    while (daysAdded < duration) {
      currentDate.setDate(currentDate.getDate() + 1);
      const pythonDay = jsDayToPythonDay(currentDate.getDay());
      if (workingDays.includes(pythonDay)) {
        daysAdded++;
      }
    }
    
    // Format date as YYYY-MM-DD
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    const day = String(currentDate.getDate()).padStart(2, '0');
    targetInput.value = `${year}-${month}-${day}`;
  }

  // Setup event listeners for task form
  const taskDuration = document.getElementById('task-duration');
  const taskStartDate = document.getElementById('task-start-date');
  
  if (taskDuration && taskStartDate) {
    taskDuration.addEventListener('input', () => {
      calculateDueDate('task-start-date', 'task-duration', 'task-due-date', 'input.working-day-check[data-target="task-due-date"]');
    });
    
    taskStartDate.addEventListener('change', () => {
      if (taskDuration.value) {
        calculateDueDate('task-start-date', 'task-duration', 'task-due-date', 'input.working-day-check[data-target="task-due-date"]');
      }
    });
    
    // Also recalculate when working days change
    document.querySelectorAll('input.working-day-check[data-target="task-due-date"]').forEach(cb => {
      cb.addEventListener('change', () => {
        if (taskDuration.value && taskStartDate.value) {
          calculateDueDate('task-start-date', 'task-duration', 'task-due-date', 'input.working-day-check[data-target="task-due-date"]');
        }
      });
    });
  }
</script>
{% endblock %}
