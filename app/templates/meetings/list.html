{% extends 'base.html' %}
{% block content %}
<div class="mb-5">
  <h1 class="text-2xl font-semibold">Meetings</h1>
</div>

<div class="mb-6 p-4 bg-white rounded-lg border border-slate-200">
  <h2 class="text-lg font-medium mb-3">Schedule New Meeting</h2>
  {% if error %}
    <div class="mb-4 p-3 bg-red-50 border border-red-300 text-red-800 rounded">
      {{ error }}
    </div>
  {% endif %}
  <form method="post" action="/web/meetings/create" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="return validateMeetingTimes()">
    <div class="md:col-span-2">
      <label class="block text-sm font-medium mb-1">Title</label>
      <input type="text" name="title" required class="w-full rounded border border-slate-300 px-3 py-2" placeholder="Meeting title" />
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">Start Time</label>
      <input type="datetime-local" id="start_time" name="start_time" required class="w-full rounded border border-slate-300 px-3 py-2" onchange="updateEndTime()" />
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">End Time</label>
      <input type="datetime-local" id="end_time" name="end_time" required class="w-full rounded border border-slate-300 px-3 py-2" />
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">Platform</label>
      <select name="platform" required class="w-full rounded border border-slate-300 px-3 py-2">
        <option value="zoom">Zoom</option>
        <option value="teams">Microsoft Teams</option>
        <option value="discord">Discord</option>
        <option value="in_person">In Person</option>
        <option value="google_meet">Google Meet</option>
        <option value="phone">Phone</option>
        <option value="other">Other</option>
      </select>
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">Meeting URL (optional)</label>
      <input type="url" name="meeting_url" class="w-full rounded border border-slate-300 px-3 py-2" placeholder="https://..." />
    </div>
    
    <div class="md:col-span-2">
      <label class="block text-sm font-medium mb-1">Description (optional)</label>
      <textarea name="description" rows="2" class="w-full rounded border border-slate-300 px-3 py-2" placeholder="Meeting description or agenda"></textarea>
    </div>
    
    <div class="md:col-span-2">
      <label class="block text-sm font-medium mb-1">Attendees</label>
      <div class="border border-slate-300 rounded p-3 max-h-48 overflow-y-auto">
        {% for u in users %}
          <label class="flex items-center gap-2 mb-2">
            <input type="checkbox" name="attendee_ids" value="{{ u.id }}" {% if u.id == user.id %}checked{% endif %} class="rounded" />
            <span class="text-sm">{{ u.full_name or u.email }}</span>
          </label>
        {% endfor %}
      </div>
    </div>
    
    <div class="md:col-span-2">
      <button type="submit" class="px-4 py-2 bg-slate-900 text-white rounded hover:bg-slate-800">Schedule Meeting</button>
    </div>
  </form>
</div>

<div class="space-y-4">
  {% if meetings %}
    {% for meeting in meetings %}
      <div class="p-4 bg-white rounded-lg border border-slate-200">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-medium">{{ meeting.title }}</h3>
              {% if meeting.is_cancelled %}
                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded">‚ùå CANCELLED</span>
              {% endif %}
            </div>
            {% if meeting.description %}
              <p class="text-sm text-slate-600 mt-1">{{ meeting.description }}</p>
            {% endif %}
            <div class="flex items-center gap-4 mt-3 text-sm text-slate-500">
              <span>üìÖ {{ meeting.date.strftime('%d/%m/%Y') }}</span>
              <span>üïê {{ meeting.start_time.strftime('%I:%M %p') }} ({{ meeting.duration_minutes }} min)</span>
              <span class="px-2 py-1 bg-slate-100 rounded text-xs">{{ meeting.platform.value.replace('_', ' ').title() }}</span>
            </div>
            {% if meeting.url and not meeting.is_cancelled %}
              <div class="mt-2">
                <a href="{{ meeting.url }}" target="_blank" class="text-sm text-blue-600 hover:underline">Join Meeting ‚Üí</a>
              </div>
            {% endif %}
          </div>
          {% if user.is_admin or meeting.organizer_id == user.id %}
            {% if not meeting.is_cancelled %}
              <div class="ml-4">
                <form method="post" action="/web/meetings/{{ meeting.id }}/cancel" onsubmit="return confirm('Cancel this meeting? All attendees will be notified.');">
                  <button type="submit" class="px-3 py-1 text-sm font-medium text-red-700 bg-red-50 border border-red-300 rounded hover:bg-red-100 transition">
                    Cancel Meeting
                  </button>
                </form>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="text-center py-12 text-slate-500">
      <p>No meetings scheduled yet.</p>
    </div>
  {% endif %}
</div>

<script>
function updateEndTime() {
  const startInput = document.getElementById('start_time');
  const endInput = document.getElementById('end_time');
  
  if (startInput.value && !endInput.value) {
    // Auto-set end time to 1 hour after start time
    const startDate = new Date(startInput.value);
    startDate.setHours(startDate.getHours() + 1);
    
    // Format to datetime-local string (YYYY-MM-DDTHH:MM)
    const year = startDate.getFullYear();
    const month = String(startDate.getMonth() + 1).padStart(2, '0');
    const day = String(startDate.getDate()).padStart(2, '0');
    const hours = String(startDate.getHours()).padStart(2, '0');
    const minutes = String(startDate.getMinutes()).padStart(2, '0');
    
    endInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
  }
}

function validateMeetingTimes() {
  const startInput = document.getElementById('start_time');
  const endInput = document.getElementById('end_time');
  
  if (!startInput.value || !endInput.value) {
    return true; // Let browser validation handle required fields
  }
  
  const startDate = new Date(startInput.value);
  const endDate = new Date(endInput.value);
  
  if (endDate <= startDate) {
    alert('End time must be after start time. Please select a later end time.');
    endInput.focus();
    return false;
  }
  
  return true;
}
</script>

{% endblock %}
