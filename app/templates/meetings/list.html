{% extends 'base.html' %}
{% block content %}
<div class="mb-5">
  <h1 class="text-2xl font-semibold">Meetings</h1>
</div>

<div class="mb-6 p-4 bg-white rounded-lg border border-slate-200">
  <h2 class="text-lg font-medium mb-3">Schedule New Meeting</h2>
  {% if error %}
    <div class="mb-4 p-3 bg-red-50 border border-red-300 text-red-800 rounded">
      {{ error }}
    </div>
  {% endif %}
  {% if success_message %}
    <div class="mb-4 p-3 bg-green-50 border border-green-300 text-green-800 rounded">
      {{ success_message }}
    </div>
  {% endif %}
  
  <!-- Attendee Preferences Notice -->
  <div id="attendee-preferences" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
    <div class="flex items-start gap-2">
      <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div>
        <p class="text-sm font-medium text-blue-800">Attendee Preferences</p>
        <p class="text-sm text-blue-700 mt-1" id="preferences-text"></p>
      </div>
    </div>
  </div>
  
  <form method="post" action="/web/meetings/create" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="return validateMeetingTimes()">
    <div class="md:col-span-2">
      <label class="block text-sm font-medium mb-1">Title</label>
      <input type="text" name="title" required class="w-full rounded border border-slate-300 px-3 py-2" placeholder="Meeting title" />
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">Start Time</label>
      <input type="datetime-local" id="start_time" name="start_time" required class="w-full rounded border border-slate-300 px-3 py-2" onchange="updateEndTime()" />
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">End Time</label>
      <input type="datetime-local" id="end_time" name="end_time" required class="w-full rounded border border-slate-300 px-3 py-2" />
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">Platform</label>
      <select name="platform" id="platform" required class="w-full rounded border border-slate-300 px-3 py-2" onchange="updateLinkOptions()">
        <option value="zoom">Zoom</option>
        <option value="teams">Microsoft Teams</option>
        <option value="discord">Discord</option>
        <option value="in_person">In Person</option>
        <option value="google_meet">Google Meet</option>
        <option value="phone">Phone</option>
        <option value="other">Other</option>
      </select>
    </div>
    
    <div>
      <label class="block text-sm font-medium mb-1">Meeting URL</label>
      <div class="space-y-2">
        <input type="url" name="meeting_url" id="meeting_url" class="w-full rounded border border-slate-300 px-3 py-2" placeholder="https://..." />
        
        <!-- Auto-generate options -->
        <div id="auto-generate-options" class="hidden">
          {% if user.google_access_token %}
          <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer hover:text-slate-800">
            <input type="checkbox" name="auto_generate_meet" id="auto_generate_meet" class="rounded" />
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm-1.5 6h3v6h-3V6zm0 7.5h3v3h-3v-3z"/>
            </svg>
            <span>Auto-generate Google Meet link</span>
          </label>
          {% else %}
          <p class="text-xs text-amber-600">
            <a href="/web/google/link" class="underline hover:no-underline">Link your Google account</a> to auto-generate Google Meet links
          </p>
          {% endif %}
        </div>
        
        <div id="teams-link-help" class="hidden text-xs text-slate-500">
          <p>üí° To create a Teams meeting:</p>
          <ol class="list-decimal ml-4 mt-1 space-y-1">
            <li>Open Microsoft Teams</li>
            <li>Click "New meeting" ‚Üí "Copy join link"</li>
            <li>Paste the link above</li>
          </ol>
        </div>
      </div>
    </div>
    
    <div class="md:col-span-2">
      <label class="block text-sm font-medium mb-1">Description (optional)</label>
      <textarea name="description" rows="2" class="w-full rounded border border-slate-300 px-3 py-2" placeholder="Meeting description or agenda"></textarea>
    </div>
    
    <div class="md:col-span-2">
      <label class="block text-sm font-medium mb-1">Attendees</label>
      <div class="border border-slate-300 rounded p-3 max-h-48 overflow-y-auto">
        {% for u in users %}
          <label class="flex items-center gap-2 mb-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
            <input type="checkbox" name="attendee_ids" value="{{ u.id }}" 
                   {% if u.id == user.id %}checked{% endif %} 
                   class="rounded attendee-checkbox"
                   data-user-id="{{ u.id }}"
                   data-preferred-platform="{{ u.preferred_meeting_platform.value if u.preferred_meeting_platform else '' }}"
                   onchange="updatePreferencesNotice()" />
            <span class="text-sm flex-1">{{ u.full_name or u.email }}</span>
            {% if u.preferred_meeting_platform %}
              <span class="px-2 py-0.5 text-xs rounded-full 
                {% if u.preferred_meeting_platform.value == 'google_meet' %}bg-green-100 text-green-700
                {% elif u.preferred_meeting_platform.value == 'teams' %}bg-blue-100 text-blue-700
                {% elif u.preferred_meeting_platform.value == 'zoom' %}bg-indigo-100 text-indigo-700
                {% else %}bg-slate-100 text-slate-700{% endif %}">
                {{ u.preferred_meeting_platform.value.replace('_', ' ').title() }}
              </span>
            {% endif %}
          </label>
        {% endfor %}
      </div>
      <p class="text-xs text-slate-500 mt-1">Users can set their preferred meeting platform in their profile settings</p>
    </div>
    
    <div class="md:col-span-2">
      <button type="submit" class="px-4 py-2 bg-slate-900 text-white rounded hover:bg-slate-800">Schedule Meeting</button>
    </div>
  </form>
</div>

<div class="space-y-4">
  {% if meetings %}
    {% for meeting in meetings %}
      <div class="p-4 bg-white rounded-lg border border-slate-200">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-medium">{{ meeting.title }}</h3>
              {% if meeting.is_cancelled %}
                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded">‚ùå CANCELLED</span>
              {% endif %}
            </div>
            {% if meeting.description %}
              <p class="text-sm text-slate-600 mt-1">{{ meeting.description }}</p>
            {% endif %}
            <div class="flex items-center gap-4 mt-3 text-sm text-slate-500">
              <span>üìÖ {{ meeting.date.strftime('%d/%m/%Y') }}</span>
              <span>üïê {{ meeting.start_time.strftime('%I:%M %p') }} ({{ meeting.duration_minutes }} min)</span>
              <span class="px-2 py-1 bg-slate-100 rounded text-xs">{{ meeting.platform.value.replace('_', ' ').title() }}</span>
            </div>
            {% if meeting.url and not meeting.is_cancelled %}
              <div class="mt-2">
                <a href="{{ meeting.url }}" target="_blank" class="text-sm text-blue-600 hover:underline">Join Meeting ‚Üí</a>
              </div>
            {% endif %}
          </div>
          {% if user.is_admin or meeting.organizer_id == user.id %}
            {% if not meeting.is_cancelled %}
              <div class="ml-4">
                <form method="post" action="/web/meetings/{{ meeting.id }}/cancel" onsubmit="return confirm('Cancel this meeting? All attendees will be notified.');">
                  <button type="submit" class="px-3 py-1 text-sm font-medium text-red-700 bg-red-50 border border-red-300 rounded hover:bg-red-100 transition">
                    Cancel Meeting
                  </button>
                </form>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="text-center py-12 text-slate-500">
      <p>No meetings scheduled yet.</p>
    </div>
  {% endif %}
</div>

<script>
function updateEndTime() {
  const startInput = document.getElementById('start_time');
  const endInput = document.getElementById('end_time');
  
  if (startInput.value && !endInput.value) {
    // Auto-set end time to 1 hour after start time
    const startDate = new Date(startInput.value);
    startDate.setHours(startDate.getHours() + 1);
    
    // Format to datetime-local string (YYYY-MM-DDTHH:MM)
    const year = startDate.getFullYear();
    const month = String(startDate.getMonth() + 1).padStart(2, '0');
    const day = String(startDate.getDate()).padStart(2, '0');
    const hours = String(startDate.getHours()).padStart(2, '0');
    const minutes = String(startDate.getMinutes()).padStart(2, '0');
    
    endInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
  }
}

function validateMeetingTimes() {
  const startInput = document.getElementById('start_time');
  const endInput = document.getElementById('end_time');
  
  if (!startInput.value || !endInput.value) {
    return true; // Let browser validation handle required fields
  }
  
  const startDate = new Date(startInput.value);
  const endDate = new Date(endInput.value);
  
  if (endDate <= startDate) {
    alert('End time must be after start time. Please select a later end time.');
    endInput.focus();
    return false;
  }
  
  return true;
}

function updateLinkOptions() {
  const platform = document.getElementById('platform').value;
  const autoGenerateOptions = document.getElementById('auto-generate-options');
  const teamsHelp = document.getElementById('teams-link-help');
  const autoGenerateMeet = document.getElementById('auto_generate_meet');
  
  // Show/hide auto-generate options for Google Meet
  if (platform === 'google_meet') {
    autoGenerateOptions.classList.remove('hidden');
    teamsHelp.classList.add('hidden');
  } else if (platform === 'teams') {
    autoGenerateOptions.classList.add('hidden');
    teamsHelp.classList.remove('hidden');
    if (autoGenerateMeet) autoGenerateMeet.checked = false;
  } else {
    autoGenerateOptions.classList.add('hidden');
    teamsHelp.classList.add('hidden');
    if (autoGenerateMeet) autoGenerateMeet.checked = false;
  }
}

function updatePreferencesNotice() {
  const checkboxes = document.querySelectorAll('.attendee-checkbox:checked');
  const preferencesDiv = document.getElementById('attendee-preferences');
  const preferencesText = document.getElementById('preferences-text');
  
  // Count preferences
  const preferences = {};
  checkboxes.forEach(cb => {
    const platform = cb.dataset.preferredPlatform;
    if (platform) {
      preferences[platform] = (preferences[platform] || 0) + 1;
    }
  });
  
  // Build message
  const platformNames = {
    'google_meet': 'Google Meet',
    'teams': 'Microsoft Teams',
    'zoom': 'Zoom',
    'discord': 'Discord',
    'phone': 'Phone',
    'in_person': 'In Person',
    'other': 'Other'
  };
  
  const prefs = Object.entries(preferences);
  if (prefs.length > 0) {
    const messages = prefs.map(([platform, count]) => {
      return `${count} attendee${count > 1 ? 's' : ''} prefer${count === 1 ? 's' : ''} ${platformNames[platform] || platform}`;
    });
    preferencesText.textContent = messages.join(', ') + '.';
    preferencesDiv.classList.remove('hidden');
    
    // Auto-select platform if all attendees prefer the same
    if (prefs.length === 1 && checkboxes.length > 0) {
      const suggestedPlatform = prefs[0][0];
      const platformSelect = document.getElementById('platform');
      // Highlight the suggestion
      preferencesText.innerHTML = messages[0] + `. <button type="button" onclick="document.getElementById('platform').value='${suggestedPlatform}'; updateLinkOptions();" class="underline font-medium hover:no-underline">Click to select ${platformNames[suggestedPlatform]}</button>`;
    }
  } else {
    preferencesDiv.classList.add('hidden');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updatePreferencesNotice();
  updateLinkOptions();
});
</script>

{% endblock %}
